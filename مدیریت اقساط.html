<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت اقساط تعاونی فرهنگیان پرسنل کارخانجات استیل البرز و خرم صنعت</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- کتابخانه تاریخ شمسی -->
    <script src="https://cdn.jsdelivr.net/npm/jalali-moment/dist/jalali-moment.browser.js"></script>
    <style>
        * {
            font-family: 'Tahoma', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px 30px;
            text-align: center;
            border-bottom: 5px solid #3498db;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        header h1 i {
            color: #3498db;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background-color: #2c3e50;
            overflow: hidden;
        }
        
        .tab-button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 18px 25px;
            font-size: 16px;
            color: white;
            transition: 0.3s;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-button:hover {
            background-color: #34495e;
        }
        
        .tab-button.active {
            background-color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f8ff;
        }
        
        .input-form {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #3498db;
        }
        
        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
        }
        
        .delete-btn {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
        }
        
        .paid {
            color: #27ae60;
            font-weight: bold;
        }
        
        .unpaid {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .debts-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            padding: 10px;
        }
        
        .debt-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        
        .debt-item:hover {
            background: #e9ecef;
        }
        
        .debt-item.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        @media (max-width: 768px) {
            .tab-button {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> داشبورد مدیریت اقساط تعاونی فرهنگیان پرسنل کارخانجات استیل البرز و خرم صنعت</h1>
            <p class="subtitle">امور کارکنان صنایع استیل البرز</p>
        </header>
        
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'customers')">
                <i class="fas fa-users"></i> مشتریان
            </button>
            <button class="tab-button" onclick="openTab(event, 'debts')">
                <i class="fas fa-file-invoice-dollar"></i> ثبت بدهی
            </button>
            <button class="tab-button" onclick="openTab(event, 'payments')">
                <i class="fas fa-money-check-alt"></i> پرداخت قسط
            </button>
            <button class="tab-button" onclick="openTab(event, 'dashboard')">
                <i class="fas fa-tachometer-alt"></i> داشبورد
            </button>
        </div>
        
        <!-- تب مشتریان -->
        <div id="customers" class="tab-content active">
            <h2><i class="fas fa-users"></i> مدیریت اطلاعات مشتریان</h2>
            
            <div class="input-form">
                <h3>افزودن مشتری جدید</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeCode">کد پرسنلی</label>
                        <input type="number" id="employeeCode" placeholder="مثال: 1001">
                    </div>
                    <div class="form-group">
                        <label for="firstName">نام</label>
                        <input type="text" id="firstName" placeholder="مثال: علی">
                    </div>
                    <div class="form-group">
                        <label for="lastName">نام خانوادگی</label>
                        <input type="text" id="lastName" placeholder="مثال: رضایی">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nationalCode">کد ملی</label>
                        <input type="text" id="nationalCode" placeholder="مثال: 0012345678">
                    </div>
                    <div class="form-group">
                        <label for="hireDate">تاریخ استخدام (شمسی)</label>
                        <input type="text" id="hireDate" placeholder="1400/01/01">
                    </div>
                    <div class="form-group">
                        <label for="status">وضعیت</label>
                        <select id="status">
                            <option value="فعال">فعال</option>
                            <option value="غیرفعال">غیرفعال</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addCustomer()">
                    <i class="fas fa-user-plus"></i> افزودن مشتری
                </button>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchCustomer" placeholder="جستجوی مشتری بر اساس نام، کد پرسنلی یا کد ملی...">
                <button class="btn" onclick="searchCustomers()">
                    <i class="fas fa-search"></i> جستجو
                </button>
                <button class="btn btn-warning" onclick="clearSearch()">
                    <i class="fas fa-times"></i> پاک کردن
                </button>
            </div>
            
            <table id="customersTable">
                <thead>
                    <tr>
                        <th>کد پرسنلی</th>
                        <th>نام</th>
                        <th>نام خانوادگی</th>
                        <th>کد ملی</th>
                        <th>تاریخ استخدام</th>
                        <th>وضعیت</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="customersTableBody">
                    <!-- داده‌ها به صورت پویا اضافه می‌شوند -->
                </tbody>
            </table>
            
            <div class="actions">
                <button class="btn" onclick="exportToCSV('customers')">
                    <i class="fas fa-file-export"></i> خروجی Excel (CSV)
                </button>
                <button class="btn btn-danger" onclick="clearAllCustomers()">
                    <i class="fas fa-trash-alt"></i> حذف همه مشتریان
                </button>
            </div>
        </div>
        
        <!-- تب ثبت بدهی -->
        <div id="debts" class="tab-content">
            <h2><i class="fas fa-file-invoice-dollar"></i> ثبت بدهی و اقساط</h2>
            
            <div class="input-form">
                <h3>ثبت بدهی جدید</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="debtEmployeeCode">کد پرسنلی مشتری</label>
                        <input type="number" id="debtEmployeeCode" placeholder="کد پرسنلی را وارد کنید">
                        <button class="btn" style="margin-top: 5px; width: 100%;" onclick="findCustomerByCode()">
                            <i class="fas fa-search"></i> پیدا کردن مشتری
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="debtCustomerName">نام و نام خانوادگی</label>
                        <input type="text" id="debtCustomerName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="debtAmount">مبلغ کل بدهی (ریال)</label>
                        <input type="number" id="debtAmount" placeholder="مثال: 10000000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="installmentCount">تعداد اقساط</label>
                        <select id="installmentCount">
                            <option value="1">1 قسط</option>
                            <option value="2">2 قسط</option>
                            <option value="3">3 قسط</option>
                            <option value="4">4 قسط</option>
                            <option value="5">5 قسط</option>
                            <option value="6">6 قسط</option>
                            <option value="7">7 قسط</option>
                            <option value="8">8 قسط</option>
                            <option value="9">9 قسط</option>
                            <option value="10">10 قسط</option>
                            <option value="11">11 قسط</option>
                            <option value="12">12 قسط</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="installmentAmount">مبلغ هر قسط (ریال)</label>
                        <input type="number" id="installmentAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="debtDate">تاریخ ثبت (شمسی)</label>
                        <input type="text" id="debtDate" placeholder="1402/10/15">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addDebt()">
                    <i class="fas fa-save"></i> ثبت بدهی
                </button>
                <button class="btn" onclick="calculateInstallment()">
                    <i class="fas fa-calculator"></i> محاسبه اقساط
                </button>
            </div>
            
            <table id="debtsTable">
                <thead>
                    <tr>
                        <th>شماره سند</th>
                        <th>کد پرسنلی</th>
                        <th>نام مشتری</th>
                        <th>مبلغ کل</th>
                        <th>تعداد اقساط</th>
                        <th>مبلغ هر قسط</th>
                        <th>تاریخ ثبت</th>
                        <th>وضعیت</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="debtsTableBody">
                    <!-- داده‌ها به صورت پویا اضافه می‌شوند -->
                </tbody>
            </table>
            
            <div class="actions">
                <button class="btn" onclick="exportToCSV('debts')">
                    <i class="fas fa-file-export"></i> خروجی Excel (CSV)
                </button>
            </div>
        </div>
        
        <!-- تب پرداخت قسط -->
        <div id="payments" class="tab-content">
            <h2><i class="fas fa-money-check-alt"></i> ثبت پرداخت قسط</h2>
            
            <div class="input-form">
                <h3>ثبت پرداخت جدید</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentEmployeeCode">کد پرسنلی</label>
                        <input type="number" id="paymentEmployeeCode" placeholder="کد پرسنلی را وارد کنید">
                        <button class="btn" style="margin-top: 5px; width: 100%;" onclick="findCustomerForPayment()">
                            <i class="fas fa-search"></i> پیدا کردن مشتری
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="paymentCustomerName">نام و نام خانوادگی</label>
                        <input type="text" id="paymentCustomerName" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>بدهی‌های مشتری</label>
                        <div id="customerDebtsList" class="debts-list">
                            <!-- لیست بدهی‌ها به صورت پویا نمایش داده می‌شود -->
                        </div>
                        <input type="hidden" id="selectedDebtId">
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">مبلغ پرداختی (ریال)</label>
                        <input type="number" id="paymentAmount" placeholder="مبلغ را وارد کنید">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="installmentNumber">شماره قسط</label>
                        <input type="number" id="installmentNumber" placeholder="مثال: 1">
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">تاریخ پرداخت (شمسی)</label>
                        <input type="text" id="paymentDate" placeholder="1402/10/15">
                    </div>
                    <div class="form-group">
                        <label for="paymentMonth">ماه پرداخت</label>
                        <select id="paymentMonth">
                            <option value="فروردین">فروردین</option>
                            <option value="اردیبهشت">اردیبهشت</option>
                            <option value="خرداد">خرداد</option>
                            <option value="تیر">تیر</option>
                            <option value="مرداد">مرداد</option>
                            <option value="شهریور">شهریور</option>
                            <option value="مهر">مهر</option>
                            <option value="آبان">آبان</option>
                            <option value="آذر">آذر</option>
                            <option value="دی">دی</option>
                            <option value="بهمن">بهمن</option>
                            <option value="اسفند">اسفند</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentYear">سال پرداخت</label>
                        <input type="number" id="paymentYear" placeholder="1402" value="1402">
                    </div>
                    <div class="form-group">
                        <label for="paymentDescription">توضیحات</label>
                        <input type="text" id="paymentDescription" placeholder="توضیحات پرداخت">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addPayment()">
                    <i class="fas fa-money-bill-wave"></i> ثبت پرداخت
                </button>
            </div>
            
            <table id="paymentsTable">
                <thead>
                    <tr>
                        <th>شماره پرداخت</th>
                        <th>کد پرسنلی</th>
                        <th>نام مشتری</th>
                        <th>شماره سند</th>
                        <th>مبلغ پرداختی</th>
                        <th>شماره قسط</th>
                        <th>تاریخ پرداخت</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="paymentsTableBody">
                    <!-- داده‌ها به صورت پویا اضافه می‌شوند -->
                </tbody>
            </table>
            
            <div class="actions">
                <button class="btn" onclick="exportToCSV('payments')">
                    <i class="fas fa-file-export"></i> خروجی Excel (CSV)
                </button>
            </div>
        </div>
        
        <!-- تب داشبورد -->
        <div id="dashboard" class="tab-content">
            <h2><i class="fas fa-tachometer-alt"></i> داشبورد آماری</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <h3>تعداد مشتریان فعال</h3>
                    <div class="stat-value" id="activeCustomers">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>مجموع بدهی‌های جاری</h3>
                    <div class="stat-value" id="totalDebts">0 ریال</div>
                </div>
                
                <div class="stat-card">
                    <h3>مجموع پرداختی‌ها</h3>
                    <div class="stat-value" id="totalPayments">0 ریال</div>
                </div>
                
                <div class="stat-card">
                    <h3>بدهی‌های معوق</h3>
                    <div class="stat-value" id="overdueDebts">0 مورد</div>
                </div>
            </div>
            
            <h3>جستجوی وضعیت بدهی مشتری</h3>
            <div class="search-box">
                <input type="number" id="dashboardEmployeeCode" placeholder="کد پرسنلی مشتری را وارد کنید">
                <button class="btn" onclick="searchCustomerDebts()">
                    <i class="fas fa-search"></i> جستجو
                </button>
            </div>
            
            <div id="customerDebtResult" style="margin-top: 20px;">
                <!-- نتایج جستجو نمایش داده می‌شود -->
            </div>
            
            <h3 style="margin-top: 30px;">گزارش پرداخت‌های ماه جاری</h3>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="reportMonth">ماه</label>
                    <select id="reportMonth">
                        <option value="فروردین">فروردین</option>
                        <option value="اردیبهشت">اردیبهشت</option>
                        <option value="خرداد">خرداد</option>
                        <option value="تیر">تیر</option>
                        <option value="مرداد">مرداد</option>
                        <option value="شهریور">شهریور</option>
                        <option value="مهر">مهر</option>
                        <option value="آبان">آبان</option>
                        <option value="آذر">آذر</option>
                        <option value="دی">دی</option>
                        <option value="بهمن">بهمن</option>
                        <option value="اسفند">اسفند</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportYear">سال</label>
                    <input type="number" id="reportYear" value="1402">
                </div>
                <div class="form-group">
                    <label style="visibility: hidden;">.</label>
                    <button class="btn" onclick="generateMonthlyReport()">
                        <i class="fas fa-chart-bar"></i> ایجاد گزارش
                    </button>
                </div>
            </div>
            
            <table id="monthlyReportTable">
                <thead>
                    <tr>
                        <th>کد پرسنلی</th>
                        <th>نام مشتری</th>
                        <th>شماره سند</th>
                        <th>مبلغ پرداختی</th>
                        <th>شماره قسط</th>
                        <th>تاریخ پرداخت</th>
                    </tr>
                </thead>
                <tbody id="monthlyReportTableBody">
                    <!-- گزارش ماهانه نمایش داده می‌شود -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p>طراحی توسط استاد اعظم امیرعباس چهرازی</p>
            <p></p>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="backupData()">
                    <i class="fas fa-download"></i> پشتیبان‌گیری از داده‌ها
                </button>
                <button class="btn btn-warning" onclick="restoreData()">
                    <i class="fas fa-upload"></i> بازیابی داده‌ها
                </button>
            </div>
        </div>
    </div>

    <script>
        // داده‌های اولیه
        let customers = JSON.parse(localStorage.getItem('customers')) || [
            {id: 1001, firstName: "علی", lastName: "رضایی", nationalCode: "0012345678", hireDate: "1400/01/01", status: "فعال"},
            {id: 1002, firstName: "مریم", lastName: "محمدی", nationalCode: "0023456789", hireDate: "1399/05/15", status: "فعال"},
            {id: 1003, firstName: "رضا", lastName: "کریمی", nationalCode: "0034567890", hireDate: "1401/03/20", status: "غیرفعال"}
        ];
        
        let debts = JSON.parse(localStorage.getItem('debts')) || [
            {id: 5001, employeeCode: 1001, customerName: "علی رضایی", amount: 10000000, installments: 4, installmentAmount: 2500000, date: "1402/10/15", status: "جاری", paidAmount: 0},
            {id: 5002, employeeCode: 1002, customerName: "مریم محمدی", amount: 15000000, installments: 10, installmentAmount: 1500000, date: "1402/09/20", status: "جاری", paidAmount: 3000000}
        ];
        
        let payments = JSON.parse(localStorage.getItem('payments')) || [
            {id: 8001, debtId: 5002, employeeCode: 1002, customerName: "مریم محمدی", amount: 1500000, installmentNumber: 1, date: "1402/10/05", month: "مهر", year: "1402", description: "قسط اول"},
            {id: 8002, debtId: 5002, employeeCode: 1002, customerName: "مریم محمدی", amount: 1500000, installmentNumber: 2, date: "1402/11/05", month: "آبان", year: "1402", description: "قسط دوم"}
        ];
        
        // ذخیره داده‌ها در localStorage
        function saveData() {
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('debts', JSON.stringify(debts));
            localStorage.setItem('payments', JSON.stringify(payments));
            updateDashboardStats();
        }
        
        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', function() {
            // تنظیم تاریخ امروز شمسی به صورت پیش‌فرض
            const today = moment().format('jYYYY/jMM/jDD');
            document.getElementById('hireDate').value = today;
            document.getElementById('debtDate').value = today;
            document.getElementById('paymentDate').value = today;
            
            // تنظیم سال جاری شمسی
            const currentYear = moment().format('jYYYY');
            document.getElementById('paymentYear').value = currentYear;
            document.getElementById('reportYear').value = currentYear;
            
            // بارگذاری داده‌ها
            loadCustomers();
            loadDebts();
            loadPayments();
            updateDashboardStats();
            
            // تنظیم رویداد تغییر برای محاسبه اقساط
            document.getElementById('debtAmount').addEventListener('input', calculateInstallment);
            document.getElementById('installmentCount').addEventListener('change', calculateInstallment);
            
            // رویداد جستجوی مشتری
            document.getElementById('searchCustomer').addEventListener('input', function() {
                if (this.value === '') {
                    loadCustomers();
                }
            });
        });
        
        // تابع باز کردن تب‌ها
        function openTab(evt, tabName) {
            const tabcontents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontents.length; i++) {
                tabcontents[i].classList.remove("active");
            }
            
            const tabbuttons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            // بروزرسانی داشبورد هنگام باز کردن تب داشبورد
            if (tabName === 'dashboard') {
                updateDashboardStats();
            }
        }
        
        // ----- توابع مربوط به مشتریان -----
        function loadCustomers() {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.firstName}</td>
                    <td>${customer.lastName}</td>
                    <td>${customer.nationalCode}</td>
                    <td>${customer.hireDate}</td>
                    <td>${customer.status}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteCustomer(${customer.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function addCustomer() {
            const employeeCode = parseInt(document.getElementById('employeeCode').value);
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const nationalCode = document.getElementById('nationalCode').value.trim();
            const hireDate = document.getElementById('hireDate').value.trim();
            const status = document.getElementById('status').value;
            
            if (!employeeCode || !firstName || !lastName || !nationalCode || !hireDate) {
                alert('لطفاً تمام فیلدهای ضروری را پر کنید');
                return;
            }
            
            // بررسی تکراری نبودن کد پرسنلی
            if (customers.some(c => c.id === employeeCode)) {
                alert('کد پرسنلی تکراری است');
                return;
            }
            
            // اعتبارسنجی تاریخ شمسی
            if (!isValidJalaliDate(hireDate)) {
                alert('تاریخ استخدام معتبر نیست. لطفاً تاریخ را به فرمت شمسی وارد کنید (مثال: 1400/01/01)');
                return;
            }
            
            const newCustomer = {
                id: employeeCode,
                firstName: firstName,
                lastName: lastName,
                nationalCode: nationalCode,
                hireDate: hireDate,
                status: status
            };
            
            customers.push(newCustomer);
            saveData();
            loadCustomers();
            
            // پاک کردن فرم
            document.getElementById('employeeCode').value = '';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('nationalCode').value = '';
            document.getElementById('hireDate').value = moment().format('jYYYY/jMM/jDD');
            
            alert('مشتری با موفقیت اضافه شد');
        }
        
        function deleteCustomer(id) {
            if (confirm('آیا از حذف این مشتری مطمئن هستید؟')) {
                customers = customers.filter(c => c.id !== id);
                // حذف بدهی‌ها و پرداخت‌های مربوطه
                const customerDebts = debts.filter(d => d.employeeCode === id);
                customerDebts.forEach(debt => {
                    payments = payments.filter(p => p.debtId !== debt.id);
                });
                debts = debts.filter(d => d.employeeCode !== id);
                
                saveData();
                loadCustomers();
                loadDebts();
                loadPayments();
                updateDashboardStats();
            }
        }
        
        function searchCustomers() {
            const query = document.getElementById('searchCustomer').value.toLowerCase().trim();
            if (!query) {
                loadCustomers();
                return;
            }
            
            const filtered = customers.filter(c => 
                c.id.toString().includes(query) ||
                c.firstName.toLowerCase().includes(query) ||
                c.lastName.toLowerCase().includes(query) ||
                c.nationalCode.includes(query)
            );
            
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            filtered.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.firstName}</td>
                    <td>${customer.lastName}</td>
                    <td>${customer.nationalCode}</td>
                    <td>${customer.hireDate}</td>
                    <td>${customer.status}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteCustomer(${customer.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function clearSearch() {
            document.getElementById('searchCustomer').value = '';
            loadCustomers();
        }
        
        function clearAllCustomers() {
            if (confirm('آیا از حذف تمام مشتریان مطمئن هستید؟ این عمل قابل برگشت نیست.')) {
                customers = [];
                debts = [];
                payments = [];
                saveData();
                loadCustomers();
                loadDebts();
                loadPayments();
                updateDashboardStats();
            }
        }
        
        // ----- توابع مربوط به بدهی‌ها -----
        function loadDebts() {
            const tbody = document.getElementById('debtsTableBody');
            tbody.innerHTML = '';
            
            debts.forEach(debt => {
                // محاسبه مبلغ پرداخت شده
                const paid = payments.filter(p => p.debtId === debt.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                // تعیین وضعیت
                let status = debt.status;
                if (paid >= debt.amount) {
                    status = "تسویه شده";
                } else if (paid > 0) {
                    status = "در حال پرداخت";
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${debt.id}</td>
                    <td>${debt.employeeCode}</td>
                    <td>${debt.customerName}</td>
                    <td>${formatCurrency(debt.amount)}</td>
                    <td>${debt.installments}</td>
                    <td>${formatCurrency(debt.installmentAmount)}</td>
                    <td>${debt.date}</td>
                    <td class="${status === 'تسویه شده' ? 'paid' : 'unpaid'}">${status}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteDebt(${debt.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function findCustomerByCode() {
            const code = parseInt(document.getElementById('debtEmployeeCode').value);
            if (!code) {
                alert('لطفاً کد پرسنلی را وارد کنید');
                return;
            }
            
            const customer = customers.find(c => c.id === code);
            if (customer) {
                document.getElementById('debtCustomerName').value = `${customer.firstName} ${customer.lastName}`;
                calculateInstallment();
            } else {
                alert('مشتری با این کد پرسنلی یافت نشد');
                document.getElementById('debtCustomerName').value = '';
            }
        }
        
        function calculateInstallment() {
            const amount = parseInt(document.getElementById('debtAmount').value) || 0;
            const installments = parseInt(document.getElementById('installmentCount').value) || 1;
            
            if (amount > 0 && installments > 0) {
                const installmentAmount = Math.round(amount / installments);
                document.getElementById('installmentAmount').value = installmentAmount;
            }
        }
        
        function addDebt() {
            const employeeCode = parseInt(document.getElementById('debtEmployeeCode').value);
            const customerName = document.getElementById('debtCustomerName').value.trim();
            const amount = parseInt(document.getElementById('debtAmount').value);
            const installments = parseInt(document.getElementById('installmentCount').value);
            const installmentAmount = parseInt(document.getElementById('installmentAmount').value);
            const date = document.getElementById('debtDate').value.trim();
            
            if (!employeeCode || !customerName || !amount || !installments || !date) {
                alert('لطفاً تمام فیلدهای ضروری را پر کنید');
                return;
            }
            
            // بررسی وجود مشتری
            const customer = customers.find(c => c.id === employeeCode);
            if (!customer) {
                alert('مشتری با این کد پرسنلی وجود ندارد');
                return;
            }
            
            // اعتبارسنجی تاریخ شمسی
            if (!isValidJalaliDate(date)) {
                alert('تاریخ ثبت معتبر نیست. لطفاً تاریخ را به فرمت شمسی وارد کنید (مثال: 1402/10/15)');
                return;
            }
            
            // تولید شماره سند جدید
            const newId = debts.length > 0 ? Math.max(...debts.map(d => d.id)) + 1 : 5001;
            
            const newDebt = {
                id: newId,
                employeeCode: employeeCode,
                customerName: customerName,
                amount: amount,
                installments: installments,
                installmentAmount: installmentAmount,
                date: date,
                status: "جاری",
                paidAmount: 0
            };
            
            debts.push(newDebt);
            saveData();
            loadDebts();
            updateDashboardStats();
            
            // پاک کردن فرم
            document.getElementById('debtEmployeeCode').value = '';
            document.getElementById('debtCustomerName').value = '';
            document.getElementById('debtAmount').value = '';
            document.getElementById('installmentAmount').value = '';
            document.getElementById('debtDate').value = moment().format('jYYYY/jMM/jDD');
            
            alert('بدهی با موفقیت ثبت شد');
        }
        
        function deleteDebt(id) {
            if (confirm('آیا از حذف این بدهی مطمئن هستید؟')) {
                debts = debts.filter(d => d.id !== id);
                // حذف پرداخت‌های مربوطه
                payments = payments.filter(p => p.debtId !== id);
                saveData();
                loadDebts();
                loadPayments();
                updateDashboardStats();
            }
        }
        
        // ----- توابع مربوط به پرداخت‌ها -----
        function loadPayments() {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${payment.employeeCode}</td>
                    <td>${payment.customerName}</td>
                    <td>${payment.debtId}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${payment.installmentNumber}</td>
                    <td>${payment.date}</td>
                    <td>
                        <button class="delete-btn" onclick="deletePayment(${payment.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function findCustomerForPayment() {
            const employeeCode = parseInt(document.getElementById('paymentEmployeeCode').value);
            if (!employeeCode) {
                alert('لطفاً کد پرسنلی را وارد کنید');
                return;
            }
            
            const customer = customers.find(c => c.id === employeeCode);
            if (!customer) {
                alert('مشتری با این کد پرسنلی یافت نشد');
                document.getElementById('paymentCustomerName').value = '';
                document.getElementById('customerDebtsList').innerHTML = '';
                document.getElementById('selectedDebtId').value = '';
                return;
            }
            
            document.getElementById('paymentCustomerName').value = `${customer.firstName} ${customer.lastName}`;
            
            // نمایش بدهی‌های مشتری
            const customerDebts = debts.filter(d => d.employeeCode === employeeCode && d.status !== 'تسویه شده');
            const debtsList = document.getElementById('customerDebtsList');
            debtsList.innerHTML = '';
            
            if (customerDebts.length === 0) {
                debtsList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">این مشتری هیچ بدهی فعالی ندارد</div>';
                document.getElementById('selectedDebtId').value = '';
                return;
            }
            
            customerDebts.forEach(debt => {
                const paid = payments.filter(p => p.debtId === debt.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                const remaining = debt.amount - paid;
                const paidInstallments = payments.filter(p => p.debtId === debt.id).length;
                
                const debtItem = document.createElement('div');
                debtItem.className = 'debt-item';
                debtItem.innerHTML = `
                    <strong>سند ${debt.id}</strong><br>
                    مبلغ کل: ${formatCurrency(debt.amount)}<br>
                    قسط: ${paidInstallments}/${debt.installments}<br>
                    مانده: ${formatCurrency(remaining)}
                `;
                
                debtItem.onclick = function() {
                    // حذف انتخاب از سایر موارد
                    document.querySelectorAll('.debt-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // انتخاب این مورد
                    this.classList.add('selected');
                    document.getElementById('selectedDebtId').value = debt.id;
                    
                    // پیشنهاد شماره قسط بعدی
                    const nextInstallment = paidInstallments + 1;
                    document.getElementById('installmentNumber').value = nextInstallment;
                    
                    // تنظیم مبلغ پرداختی پیشنهادی
                    document.getElementById('paymentAmount').value = debt.installmentAmount;
                };
                
                debtsList.appendChild(debtItem);
            });
            
            // انتخاب اولین بدهی به صورت پیش‌فرض
            if (customerDebts.length > 0) {
                debtsList.firstChild.click();
            }
        }
        
        function addPayment() {
            const employeeCode = parseInt(document.getElementById('paymentEmployeeCode').value);
            const customerName = document.getElementById('paymentCustomerName').value.trim();
            const debtId = parseInt(document.getElementById('selectedDebtId').value);
            const amount = parseInt(document.getElementById('paymentAmount').value);
            const installmentNumber = parseInt(document.getElementById('installmentNumber').value);
            const date = document.getElementById('paymentDate').value.trim();
            const month = document.getElementById('paymentMonth').value;
            const year = document.getElementById('paymentYear').value;
            const description = document.getElementById('paymentDescription').value.trim();
            
            if (!employeeCode || !customerName || !debtId || !amount || !installmentNumber || !date) {
                alert('لطفاً تمام فیلدهای ضروری را پر کنید و یک بدهی را انتخاب نمایید');
                return;
            }
            
            // بررسی وجود بدهی
            const debt = debts.find(d => d.id === debtId);
            if (!debt) {
                alert('بدهی انتخاب شده وجود ندارد');
                return;
            }
            
            // اعتبارسنجی تاریخ شمسی
            if (!isValidJalaliDate(date)) {
                alert('تاریخ پرداخت معتبر نیست. لطفاً تاریخ را به فرمت شمسی وارد کنید (مثال: 1402/10/15)');
                return;
            }
            
            // بررسی اینکه قسط تکراری نباشد
            const existingPayment = payments.find(p => p.debtId === debtId && p.installmentNumber === installmentNumber);
            if (existingPayment) {
                if (!confirm(`قسط شماره ${installmentNumber} قبلاً ثبت شده است. آیا می‌خواهید آن را بازنویسی کنید؟`)) {
                    return;
                }
                // حذف پرداخت قبلی
                payments = payments.filter(p => !(p.debtId === debtId && p.installmentNumber === installmentNumber));
            }
            
            // تولید شماره پرداخت جدید
            const newId = payments.length > 0 ? Math.max(...payments.map(p => p.id)) + 1 : 8001;
            
            const newPayment = {
                id: newId,
                debtId: debtId,
                employeeCode: employeeCode,
                customerName: customerName,
                amount: amount,
                installmentNumber: installmentNumber,
                date: date,
                month: month,
                year: year,
                description: description || `قسط شماره ${installmentNumber}`
            };
            
            payments.push(newPayment);
            saveData();
            loadPayments();
            loadDebts(); // برای بروزرسانی وضعیت بدهی
            updateDashboardStats();
            
            // ریست فرم
            document.getElementById('paymentEmployeeCode').value = '';
            document.getElementById('paymentCustomerName').value = '';
            document.getElementById('customerDebtsList').innerHTML = '';
            document.getElementById('selectedDebtId').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('installmentNumber').value = '';
            document.getElementById('paymentDate').value = moment().format('jYYYY/jMM/jDD');
            document.getElementById('paymentDescription').value = '';
            
            alert('پرداخت با موفقیت ثبت شد');
        }
        
        function deletePayment(id) {
            if (confirm('آیا از حذف این پرداخت مطمئن هستید؟')) {
                payments = payments.filter(p => p.id !== id);
                saveData();
                loadPayments();
                loadDebts(); // برای بروزرسانی وضعیت بدهی
                updateDashboardStats();
            }
        }
        
        // ----- توابع داشبورد -----
        function updateDashboardStats() {
            // تعداد مشتریان فعال
            const activeCustomersCount = customers.filter(c => c.status === 'فعال').length;
            document.getElementById('activeCustomers').textContent = activeCustomersCount;
            
            // مجموع بدهی‌های جاری
            const totalDebtsAmount = debts
                .filter(d => {
                    const paid = payments.filter(p => p.debtId === d.id)
                        .reduce((sum, p) => sum + p.amount, 0);
                    return paid < d.amount;
                })
                .reduce((sum, d) => sum + d.amount, 0);
            document.getElementById('totalDebts').textContent = formatCurrency(totalDebtsAmount);
            
            // مجموع پرداختی‌ها
            const totalPaymentsAmount = payments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('totalPayments').textContent = formatCurrency(totalPaymentsAmount);
            
            // بدهی‌های معوق (بدهی‌هایی که تاریخ آخرین قسط گذشته است)
            let overdueCount = 0;
            const currentDate = moment();
            
            debts.forEach(debt => {
                const paid = payments.filter(p => p.debtId === debt.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                if (paid < debt.amount) {
                    // اگر هنوز بدهی کامل پرداخت نشده
                    const debtDate = moment(debt.date, 'jYYYY/jMM/jDD');
                    const monthsSinceDebt = currentDate.diff(debtDate, 'jMonth');
                    
                    if (monthsSinceDebt >= debt.installments) {
                        overdueCount++;
                    }
                }
            });
            
            document.getElementById('overdueDebts').textContent = overdueCount + ' مورد';
        }
        
        function searchCustomerDebts() {
            const code = parseInt(document.getElementById('dashboardEmployeeCode').value);
            if (!code) {
                alert('لطفاً کد پرسنلی را وارد کنید');
                return;
            }
            
            const customer = customers.find(c => c.id === code);
            if (!customer) {
                document.getElementById('customerDebtResult').innerHTML = 
                    '<div style="color: red; padding: 15px; background: #ffe6e6; border-radius: 5px;">مشتری با این کد پرسنلی یافت نشد</div>';
                return;
            }
            
            const customerDebts = debts.filter(d => d.employeeCode === code);
            const customerPayments = payments.filter(p => p.employeeCode === code);
            
            let html = `<div style="background: #f8f9fa; padding: 20px; border-radius: 5px;">
                <h4>وضعیت بدهی‌های ${customer.firstName} ${customer.lastName}</h4>`;
            
            if (customerDebts.length === 0) {
                html += '<p>این مشتری هیچ بدهی ثبت شده‌ای ندارد.</p>';
            } else {
                let totalDebt = 0;
                let totalPaid = 0;
                
                customerDebts.forEach(debt => {
                    const paid = payments.filter(p => p.debtId === debt.id)
                        .reduce((sum, p) => sum + p.amount, 0);
                    const remaining = debt.amount - paid;
                    const paidInstallments = payments.filter(p => p.debtId === debt.id).length;
                    
                    totalDebt += debt.amount;
                    totalPaid += paid;
                    
                    html += `
                        <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 5px; border-right: 5px solid ${remaining > 0 ? '#e74c3c' : '#27ae60'}">
                            <strong>سند شماره ${debt.id}:</strong> ${formatCurrency(debt.amount)}<br>
                            <strong>تاریخ ثبت:</strong> ${debt.date}<br>
                            <strong>تعداد اقساط:</strong> ${debt.installments} قسط<br>
                            <strong>اقساط پرداخت شده:</strong> ${paidInstallments} از ${debt.installments}<br>
                            <strong>مبلغ پرداخت شده:</strong> ${formatCurrency(paid)}<br>
                            <strong>مانده بدهی:</strong> ${formatCurrency(remaining)}<br>
                            <strong>وضعیت:</strong> ${remaining > 0 ? 'در حال پرداخت' : 'تسویه شده'}
                        </div>
                    `;
                });
                
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #2c3e50; color: white; border-radius: 5px;">
                        <strong>جمع کل بدهی‌ها:</strong> ${formatCurrency(totalDebt)}<br>
                        <strong>جمع کل پرداختی‌ها:</strong> ${formatCurrency(totalPaid)}<br>
                        <strong>مانده کل:</strong> ${formatCurrency(totalDebt - totalPaid)}
                    </div>
                `;
            }
            
            html += `</div>`;
            document.getElementById('customerDebtResult').innerHTML = html;
        }
        
        function generateMonthlyReport() {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;
            
            const monthlyPayments = payments.filter(p => p.month === month && p.year.toString() === year.toString());
            
            const tbody = document.getElementById('monthlyReportTableBody');
            tbody.innerHTML = '';
            
            if (monthlyPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #7f8c8d;">
                            هیچ پرداختی برای ${month} ${year} ثبت نشده است
                        </td>
                    </tr>
                `;
                return;
            }
            
            monthlyPayments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.employeeCode}</td>
                    <td>${payment.customerName}</td>
                    <td>${payment.debtId}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${payment.installmentNumber}</td>
                    <td>${payment.date}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ----- توابع کمکی -----
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fa-IR').format(amount) + ' ریال';
        }
        
        function isValidJalaliDate(dateStr) {
            if (!dateStr) return false;
            
            // بررسی فرمت تاریخ شمسی (مثال: 1400/01/01)
            const regex = /^[0-9]{4}\/[0-9]{1,2}\/[0-9]{1,2}$/;
            if (!regex.test(dateStr)) return false;
            
            // استفاده از کتابخانه jalali-moment برای اعتبارسنجی دقیق
            const m = moment(dateStr, 'jYYYY/jMM/jDD');
            return m.isValid();
        }
        
        function exportToCSV(type) {
            let data, headers, filename;
            
            switch(type) {
                case 'customers':
                    data = customers;
                    headers = ['کد پرسنلی', 'نام', 'نام خانوادگی', 'کد ملی', 'تاریخ استخدام', 'وضعیت'];
                    filename = 'مشتریان.csv';
                    break;
                    
                case 'debts':
                    data = debts.map(debt => {
                        const paid = payments.filter(p => p.debtId === debt.id)
                            .reduce((sum, p) => sum + p.amount, 0);
                        const remaining = debt.amount - paid;
                        const paidInstallments = payments.filter(p => p.debtId === debt.id).length;
                        
                        return {
                            'شماره سند': debt.id,
                            'کد پرسنلی': debt.employeeCode,
                            'نام مشتری': debt.customerName,
                            'مبلغ کل': debt.amount,
                            'تعداد اقساط': debt.installments,
                            'مبلغ هر قسط': debt.installmentAmount,
                            'تاریخ ثبت': debt.date,
                            'اقساط پرداخت شده': paidInstallments,
                            'مبلغ پرداخت شده': paid,
                            'مانده بدهی': remaining,
                            'وضعیت': remaining > 0 ? 'در حال پرداخت' : 'تسویه شده'
                        };
                    });
                    headers = ['شماره سند', 'کد پرسنلی', 'نام مشتری', 'مبلغ کل', 'تعداد اقساط', 'مبلغ هر قسط', 'تاریخ ثبت', 'اقساط پرداخت شده', 'مبلغ پرداخت شده', 'مانده بدهی', 'وضعیت'];
                    filename = 'بدهی‌ها.csv';
                    break;
                    
                case 'payments':
                    data = payments.map(payment => ({
                        'شماره پرداخت': payment.id,
                        'کد پرسنلی': payment.employeeCode,
                        'نام مشتری': payment.customerName,
                        'شماره سند': payment.debtId,
                        'مبلغ پرداختی': payment.amount,
                        'شماره قسط': payment.installmentNumber,
                        'تاریخ پرداخت': payment.date,
                        'ماه': payment.month,
                        'سال': payment.year,
                        'توضیحات': payment.description
                    }));
                    headers = ['شماره پرداخت', 'کد پرسنلی', 'نام مشتری', 'شماره سند', 'مبلغ پرداختی', 'شماره قسط', 'تاریخ پرداخت', 'ماه', 'سال', 'توضیحات'];
                    filename = 'پرداخت‌ها.csv';
                    break;
                    
                default:
                    return;
            }
            
            // تبدیل داده به CSV
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(item => {
                const row = headers.map(header => {
                    let value = item[header] || '';
                    
                    // قرار دادن در کوتیشن اگر حاوی کاما باشد
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            // ایجاد فایل و دانلود
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            alert('فایل CSV با موفقیت ایجاد شد و دانلود شروع شد');
        }
        
        function backupData() {
            const backup = {
                customers: customers,
                debts: debts,
                payments: payments,
                backupDate: moment().format('jYYYY/jMM/jDD HH:mm:ss')
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `backup_management_${moment().format('jYYYY-jMM-jDD')}.json`);
            link.click();
            
            alert('پشتیبان‌گیری با موفقیت انجام شد');
        }
        
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (confirm('آیا می‌خواهید داده‌های فعلی با داده‌های پشتیبان جایگزین شوند؟')) {
                            customers = backup.customers || [];
                            debts = backup.debts || [];
                            payments = backup.payments || [];
                            
                            saveData();
                            loadCustomers();
                            loadDebts();
                            loadPayments();
                            updateDashboardStats();
                            
                            alert('داده‌ها با موفقیت بازیابی شدند');
                        }
                    } catch (error) {
                        alert('خطا در خواندن فایل پشتیبان: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
    </script>
</body>
</html>